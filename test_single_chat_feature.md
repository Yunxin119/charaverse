# 单角色单会话功能测试指南

## 功能说明

现在每个角色只能同时存在一个聊天会话。当用户尝试为已有会话的角色创建新会话时，系统会自动跳转到现有会话。

## 测试步骤

### 1. 创建角色

1. 登录系统
2. 前往角色页面 (`/characters`)
3. 点击"创建新角色"
4. 填写角色信息并保存

### 2. 开始第一次聊天

1. 在角色页面点击"聊天"按钮
2. 选择 AI 模型
3. 点击"开始对话"
4. 发送几条消息

### 3. 测试单会话限制

1. 返回角色页面
2. 再次点击同一个角色的"聊天"按钮
3. **预期结果**: 应该直接跳转到现有的聊天会话，而不是创建新会话

### 4. 测试主页聊天按钮

1. 前往主页 (`/`)
2. 在"最近的角色"部分点击"开始聊天"
3. **预期结果**: 应该跳转到现有会话

### 5. 测试聊天页面

1. 前往聊天页面 (`/chat`)
2. 点击"开始新对话"
3. 选择角色
4. **预期结果**: 如果角色已有会话，应该跳转到现有会话

## 技术实现

### 修改的文件

1. `src/app/store/chatSlice.ts` - 修改了 `createChatSession` 函数，添加了 `getExistingSession` 函数
2. `src/app/characters/page.tsx` - 修改了聊天按钮的处理逻辑
3. `src/app/chat/[sessionId]/page.tsx` - 修改了开始故事的逻辑
4. `src/app/chat/page.tsx` - 修改了开始新对话的处理
5. `src/app/page.tsx` - 修改了主页聊天按钮的处理

### 核心逻辑

1. 在创建新会话前，先检查数据库中是否已存在该用户和角色的会话
2. 如果存在，返回现有会话的 ID
3. 如果不存在，创建新会话
4. 在 UI 层面，根据返回的会话 ID 决定是跳转到现有会话还是创建新会话

## 注意事项

- 这个功能确保了每个角色只有一个活跃的聊天会话
- 用户仍然可以删除现有会话，然后创建新的会话
- 如果检查现有会话时出现错误，系统会默认创建新会话以确保用户体验
