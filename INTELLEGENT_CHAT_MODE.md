# SillyTavern式智能上下文管理系统

## 🎯 功能概述

我已经为你的聊天系统实现了类似SillyTavern的高级上下文管理功能，包括智能截断、摘要记忆等高级特性。

## 🚀 设置步骤

### 1. 数据库设置

首先在Supabase SQL Editor中执行以下脚本：

```sql
-- 执行摘要表创建脚本
\i create_summaries_table.sql
```

这将创建存储聊天摘要的数据库表。

### 2. 启用智能上下文模式

1. 进入任何聊天会话
2. 点击顶部工具栏的"🧠"图标（智能上下文管理）
3. 打开"启用增强模式"开关

## 📊 功能特性

### 核心功能

1. **智能截断 (Smart Truncation)**
   - 自动管理上下文长度，避免超出模型限制
   - 优先保留最近的对话内容
   - 智能分配token预算

2. **摘要记忆 (Summarization Memory)**
   - 当对话超过设定阈值时，自动生成摘要
   - 压缩历史对话为精炼的关键信息
   - 保持长期记忆，避免"金鱼记忆"问题

3. **上下文统计 (Context Analytics)**
   - 实时显示token使用情况
   - 监控截断的消息数量
   - 摘要状态指示器

### 配置选项详解

| 参数 | 默认值 | 说明 |
|------|--------|------|
| **最大上下文** | 4000 | 发送给AI的最大token数 |
| **预留生成空间** | 1000 | 为AI回复预留的token空间 |
| **摘要阈值** | 20 | 超过多少条消息时触发摘要 |
| **保留最近消息** | 10 | 始终保留的最新消息数 |

## 🔧 使用方法

### 基本使用

1. **正常对话**: 启用增强模式后，对话体验与之前相同
2. **查看统计**: 配置面板中会显示实时的上下文使用情况
3. **调整参数**: 根据需要微调各项配置参数

### 高级功能

#### 自动摘要生成
- 当对话消息数超过"摘要阈值"时，系统自动生成摘要
- 摘要会压缩旧对话为关键信息，释放上下文空间
- 在统计面板中会显示"⚡已启用智能摘要"

#### 模型推荐配置
点击"应用模型推荐配置"按钮，系统会根据当前选择的AI模型自动设置最佳参数：

- **GPT-4**: 8000 tokens上下文，1500预留空间
- **GPT-3.5**: 4000 tokens上下文，1000预留空间  
- **Gemini**: 8000 tokens上下文，1500预留空间
- **DeepSeek**: 4000 tokens上下文，1000预留空间

## 📈 效果对比

### 传统模式 vs 增强模式

| 方面 | 传统模式 | SillyTavern增强模式 |
|------|----------|-------------------|
| **上下文管理** | 发送全部消息 | 智能截断+摘要 |
| **长期记忆** | 金鱼记忆 | 通过摘要保持长期记忆 |
| **Token效率** | 可能浪费 | 精确控制，高效利用 |
| **对话质量** | 可能因上下文过长降级 | 稳定的高质量回复 |
| **成本控制** | 不可预测 | 可预测的API成本 |

## 🎛️ 配置建议

### 不同使用场景的推荐配置

#### 短对话场景
```
最大上下文: 2000
预留生成空间: 500
摘要阈值: 15
保留最近消息: 8
```

#### 长对话/角色扮演
```
最大上下文: 6000
预留生成空间: 1500
摘要阈值: 25
保留最近消息: 12
```

#### 成本敏感场景
```
最大上下文: 3000
预留生成空间: 800
摘要阈值: 18
保留最近消息: 6
```

## 🔍 监控和调试

### 上下文统计说明

- **总Token**: 发送给AI的总token数（包括系统提示和消息）
- **消息Token**: 纯对话消息消耗的token数
- **截断消息**: 被截断（未发送给AI）的历史消息数量

### 最佳实践

1. **定期检查统计**: 确保token使用在合理范围内
2. **调整摘要阈值**: 根据对话风格调整摘要触发点
3. **保存配置**: 找到最适合的配置后记录下来
4. **模型切换**: 切换AI模型时应用对应的推荐配置

## 🐛 故障排除

### 常见问题

1. **摘要生成失败**
   - 检查API密钥是否正确
   - 确保有足够的消息供摘要

2. **上下文过长**
   - 降低"最大上下文"设置
   - 减少"保留最近消息"数量

3. **记忆丢失**
   - 检查摘要功能是否正常工作
   - 适当降低"摘要阈值"

## 🌟 高级特性

### 未来功能预览

虽然当前版本已经实现了核心的截断和摘要功能，未来还可以扩展：

- **向量记忆**: 基于语义相似度检索历史对话
- **重要性评分**: 根据对话重要性智能选择保留内容
- **个性化摘要**: 根据角色特点定制摘要风格
- **批量摘要**: 一次性处理多个对话段落

## 💡 技术原理

系统的工作流程：

1. **消息预处理**: 分析当前对话历史
2. **上下文预算**: 计算可用的token空间
3. **智能选择**: 选择要包含的消息和摘要
4. **动态构建**: 构建优化的prompt
5. **统计反馈**: 提供实时的使用统计

这种设计确保了在有限的上下文窗口内最大化对话质量和连贯性。