# 8-5-3分层摘要系统测试指南

## 系统概览

新的分层摘要系统采用智能的"8-5-3策略"，实现以下核心功能：

### 1. 摘要分层结构
- **一级摘要 (Level 1)**: 直接从对话消息生成的原始摘要
- **超级摘要 (Level 2)**: 从5个一级摘要压缩生成的高级摘要
- **失效检测**: 当消息被删除时自动失效相关摘要

### 2. 8-5-3智能压缩策略
- **触发条件**: 一级摘要达到8条时触发压缩
- **稳定区间**: 压缩最早的5条摘要（用户很少修改的历史内容）
- **安全区间**: 保留最近的3条摘要（用户可能修改的新内容）
- **重复触发**: 压缩后如果再次积累到8条，会重复执行压缩

### 3. 智能失效处理
- 删除消息时自动失效相关摘要
- 检测孤立的超级摘要并自动失效
- 提供完整的摘要系统重建功能

## 数据库更新步骤

在测试前，需要执行以下SQL脚本：

```sql
-- 1. 执行数据库升级脚本
-- 在 Supabase SQL Editor 中运行 upgrade_summaries_table.sql
```

## 测试场景

### 场景1: 8-5-3策略摘要生成和压缩
1. 开启智能上下文管理
2. 进行长对话（超过160条消息以触发压缩）
3. 观察摘要自动生成和压缩过程

**预期结果**:
- 每20条消息生成一个一级摘要
- 第8个一级摘要生成时触发8-5-3压缩
- 最早的5条摘要被压缩为1个超级摘要
- 最近的3条摘要保持独立
- 控制台显示详细的压缩策略日志

**验证要点**:
```
对话进展: 0 -> 20 -> 40 -> 60 -> 80 -> 100 -> 120 -> 140 -> 160条消息
摘要状态: 0 -> 1  -> 2  -> 3  -> 4  -> 5   -> 6   -> 7   -> 触发压缩
结果:     压缩后 = 1个超级摘要 + 3个一级摘要 = 总共4个摘要
```

### 场景2: 摘要失效检测
1. 生成一些摘要后删除部分历史消息
2. 观察摘要失效状态更新

**预期结果**:
- 相关摘要被标记为失效
- 孤立的超级摘要也被失效
- 后续对话不会使用失效的摘要

### 场景3: 系统重建
1. 在有失效摘要的会话中
2. 触发摘要系统重建（通过清空历史再重新对话）

**预期结果**:
- 失效摘要被清理
- 根据当前消息重新生成优化的摘要结构
- 自动进行必要的压缩

## 关键指标监控

### 1. Token使用效率
- **监控位置**: 浏览器控制台的上下文统计
- **预期改善**: 相比传统方案减少30-50%的token使用

### 2. 摘要质量
- **检查方式**: 查看生成的摘要内容
- **质量标准**: 
  - 一级摘要：200字以内，记录关键事件
  - 超级摘要：300字以内，整合核心信息

### 3. 系统稳定性
- **监控点**: 摘要生成失败时的降级处理
- **预期行为**: 失败时不影响正常对话，使用现有摘要

## 故障排除

### 常见问题

1. **数据库函数不存在**
   - 确认已执行 `upgrade_summaries_table.sql`
   - 检查数据库连接权限

2. **摘要压缩失败**
   - 查看控制台错误日志
   - 检查API密钥和模型配置

3. **失效检测不工作**
   - 确认数据库触发器已创建
   - 检查消息删除的权限设置

### 调试工具

- **控制台日志**: 详细的摘要处理过程
- **数据库查询**: 检查摘要状态和层级结构
- **Redux DevTools**: 监控状态变化

## 性能优化建议

1. **批量操作**: 避免频繁的单个摘要操作
2. **缓存策略**: 利用摘要内容缓存减少重复计算
3. **压缩策略**: 根据对话长度动态调整压缩阈值

## 后续改进方向

1. **多层压缩**: 支持超级摘要的进一步压缩（Level 3, 4...）
2. **智能阈值**: 根据模型类型和对话特征动态调整阈值
3. **用户控制**: 允许用户手动管理摘要和压缩策略